# Spacelift flows Helm Chart

This Helm chart deploys Spacelift flows, a workflow automation platform, on Kubernetes.

## Prerequisites

- Kubernetes 1.19+
- Helm 3.2.0+

## Installation

### Install the Chart

```shell
helm repo add spacelift https://downloads.spacelift.io/helm
helm repo update

helm upgrade spacelift-flows spacelift/spacelift-flows --install -f values.yaml
```

## Configuration

The following table lists the configurable parameters and their default values.

**Note:** Application configuration (database URL, S3 credentials, etc.) is now managed externally via Kubernetes secrets. The chart expects a secret named by `secretName` (default: `spacelift-flows-secret`) containing a `config.yaml` file with all application settings.

### Global Configuration

| Parameter | Description | Default |
|-----------|-------------|---------|
| `global.image.repository` | Container image repository | `spacelift-flows` |
| `global.image.pullPolicy` | Image pull policy | `IfNotPresent` |
| `global.image.tag` | Image tag | `latest` |
| `global.nameOverride` | Override chart name | `""` |
| `global.fullnameOverride` | Override full chart name | `""` |

### Application Configuration

| Parameter | Description | Default |
|-----------|-------------|---------|
| `secretName` | Name of Kubernetes secret containing config.yaml | `spacelift-flows-secret` |
| `appDomain` | Application domain (used for ingress) | `""` |

> **Important:** The chart now expects application configuration to be provided via a Kubernetes secret containing a `config.yaml` file. This secret should include database URLs, S3 credentials, API keys, and other sensitive configuration. For self-hosted deployments, this secret is typically generated by the Terraform infrastructure module. An example secret (with values) can be found [here](./example-secret.yaml).

### Server Configuration

| Parameter | Description | Default |
|-----------|-------------|---------|
| `server.replicaCount` | Number of server replicas | `1` |
| `server.service.type` | Server service type | `ClusterIP` |
| `server.service.port` | Server service port | `8080` |
| `server.service.targetPort` | Server service target port | `8080` |
| `server.service.annotations` | Server service annotations | `{}` |
| `server.initMigration.resources.requests.cpu` | Migration init container CPU request | `100m` |
| `server.initMigration.resources.requests.memory` | Migration init container memory request | `128Mi` |
| `server.initMigration.resources.limits.cpu` | Migration init container CPU limit | `200m` |
| `server.initMigration.resources.limits.memory` | Migration init container memory limit | `256Mi` |
| `server.resources.requests.cpu` | CPU request | `250m` |
| `server.resources.requests.memory` | Memory request | `256Mi` |
| `server.resources.limits.cpu` | CPU limit | `500m` |
| `server.resources.limits.memory` | Memory limit | `512Mi` |
| `server.nodeSelector` | Node selector for server pods | `{}` |
| `server.tolerations` | Tolerations for server pods | `[]` |
| `server.affinity` | Affinity for server pods | `{}` |
| `server.podAnnotations` | Pod annotations for server | `{}` |
| `server.podSecurityContext` | Pod security context for server | `{}` |
| `server.securityContext` | Security context for server | `{}` |

### Worker Configuration

| Parameter | Description | Default |
|-----------|-------------|---------|
| `worker.replicaCount` | Number of worker replicas | `1` |
| `worker.resources.requests.cpu` | CPU request | `250m` |
| `worker.resources.requests.memory` | Memory request | `256Mi` |
| `worker.resources.limits.cpu` | CPU limit | `500m` |
| `worker.resources.limits.memory` | Memory limit | `512Mi` |
| `worker.nodeSelector` | Node selector for worker pods | `{}` |
| `worker.tolerations` | Tolerations for worker pods | `[]` |
| `worker.affinity` | Affinity for worker pods | `{}` |
| `worker.podAnnotations` | Pod annotations for worker | `{}` |
| `worker.podSecurityContext` | Pod security context for worker | `{}` |
| `worker.securityContext` | Security context for worker | `{}` |

### Gateway Configuration

| Parameter | Description | Default |
|-----------|-------------|---------|
| `gateway.replicaCount` | Number of gateway replicas | `1` |
| `gateway.service.type` | Gateway service type | `ClusterIP` |
| `gateway.service.ports.http` | HTTP port | `3000` |
| `gateway.service.ports.grpc` | gRPC port | `6237` |
| `gateway.service.ports.public` | Public port | `8080` |
| `gateway.service.annotations` | Gateway service annotations | `{}` |
| `gateway.resources.requests.cpu` | CPU request | `250m` |
| `gateway.resources.requests.memory` | Memory request | `256Mi` |
| `gateway.resources.limits.cpu` | CPU limit | `500m` |
| `gateway.resources.limits.memory` | Memory limit | `512Mi` |
| `gateway.nodeSelector` | Node selector for gateway pods | `{}` |
| `gateway.tolerations` | Tolerations for gateway pods | `[]` |
| `gateway.affinity` | Affinity for gateway pods | `{}` |
| `gateway.podAnnotations` | Pod annotations for gateway | `{}` |
| `gateway.podSecurityContext` | Pod security context for gateway | `{}` |
| `gateway.securityContext` | Security context for gateway | `{}` |

### Ingress Configuration

| Parameter | Description | Default |
|-----------|-------------|---------|
| `ingress.className` | Ingress class name | `""` |
| `ingress.annotations` | Ingress annotations | `{}` |
| `ingress.hosts` | Ingress hosts configuration | `[]` |
| `ingress.tls` | Ingress TLS configuration | `[]` |



## Example Values

```yaml
appDomain: "your.domain.com"

ingress:
  className: "spacelift-flows"
  annotations: {
    alb.ingress.kubernetes.io/healthcheck-port: "8080",
    alb.ingress.kubernetes.io/healthcheck-path: "/health",
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "10",
    alb.ingress.kubernetes.io/scheme: internet-facing
  }
```

## Uninstalling

```bash
helm uninstall spacelift-flows
```

## Troubleshooting

### Check Pod Status

```bash
kubectl get pods -l app.kubernetes.io/name=spacelift-flows
```

### View Logs

```bash
# Server logs
kubectl logs -l app.kubernetes.io/component=server

# Worker logs
kubectl logs -l app.kubernetes.io/component=worker

# Gateway logs
kubectl logs -l app.kubernetes.io/component=gateway
```